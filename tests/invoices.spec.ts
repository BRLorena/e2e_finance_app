// spec: TEST_PLAN.md - Invoice Management
// seed: tests/seed.spec.ts
import { test, expect } from '@playwright/test';
import { InvoicePage } from '../pages';

test.describe('Invoice Management', () => {
  test('Create Complete Invoice', async ({ page }) => {
    const invoicePage = new InvoicePage(page);
    const uniqueInvoiceNumber = `INV-2025-${Date.now()}`;
    const uniqueClientName = invoicePage.generateUniqueDescription('Tech Solutions Ltd');
    const uniqueDescription = invoicePage.generateUniqueDescription('Website redesign and development');

    await invoicePage.navigate();
    await invoicePage.createCompleteInvoice(
      uniqueInvoiceNumber,
      uniqueClientName,
      'billing@techsolutions.com',
      '2500',
      uniqueDescription,
      '2025-12-20',
      'Net 30 payment terms apply'
    );

    await invoicePage.verifyInvoiceInList(
      uniqueInvoiceNumber,
      uniqueClientName,
      uniqueDescription,
      '$2,500.00',
      '⏳ pending'
    );
  });

  test('Create Invoice with Auto-Generated Number', async ({ page }) => {
    const invoicePage = new InvoicePage(page);
    const uniqueClientName = invoicePage.generateUniqueDescription('Auto Number Client');
    const uniqueDescription = invoicePage.generateUniqueDescription('Consulting services');

    await invoicePage.navigate();
    await invoicePage.createInvoiceWithAutoNumber(
      uniqueClientName,
      '1000',
      uniqueDescription,
      '2025-12-25'
    );

    await invoicePage.verifyAutoGeneratedInvoiceNumber(uniqueClientName);
    await expect(page.getByText(uniqueDescription)).toBeVisible();
    await expect(page.getByText('Amount: $1,000.00').first()).toBeVisible();
  });

  test('Edit Existing Invoice', async ({ page }) => {
    const invoicePage = new InvoicePage(page);
    const uniqueClientName = invoicePage.generateUniqueDescription('Edit Test Client');

    await invoicePage.navigate();
    await invoicePage.createBasicInvoice(
      uniqueClientName,
      '1500',
      'Original description',
      '2025-12-30'
    );

    await expect(page.getByText(uniqueClientName)).toBeVisible();

    await invoicePage.clickEditButton();
    await invoicePage.updateInvoiceAmount('3000');
    await invoicePage.updateInvoiceStatus('Paid');
    await invoicePage.updateInvoiceDescription('Original description - UPDATED');
    await invoicePage.fillNotes('Payment received - invoice completed');
    await invoicePage.fillClientName(uniqueClientName);
    await invoicePage.fillDueDate('2025-12-30');
    await invoicePage.clickUpdateInvoiceButton();

    await expect(page.getByText('✅ paid').first()).toBeVisible();
    await expect(page.getByText('Amount: $3,000.00').first()).toBeVisible();
    await expect(page.getByText('Original description - UPDATED').first()).toBeVisible();
  });

  test('Delete Invoice', async ({ page }) => {
    const invoicePage = new InvoicePage(page);
    const uniqueClientName = invoicePage.generateUniqueDescription('Delete Test Client');

    await invoicePage.navigate();
    await invoicePage.createInvoiceWithAutoNumber(uniqueClientName, '500', 'Services to be deleted', '2025-12-31');
    
    await expect(page.getByText(uniqueClientName)).toBeVisible();

    page.on('dialog', dialog => dialog.accept());
    
    await page.getByRole('button', { name: 'Delete' }).first().click();
    
    // Wait for page to update after deletion
    await page.waitForLoadState('networkidle');
    
    await expect(page.getByText(uniqueClientName)).not.toBeVisible();
    await expect(page.getByText('Services to be deleted')).not.toBeVisible();
  });

  test('Filter Invoices by Status', async ({ page }) => {
    const invoicePage = new InvoicePage(page);
    const uniquePendingClient = `Pending Client ${Date.now()}`;
    const uniquePaidClient = `Paid Client ${Date.now()}`;
    const uniqueOverdueClient = `Overdue Client ${Date.now()}`;

    await invoicePage.navigate();

    // Create invoices with different statuses
    await invoicePage.createBasicInvoice(
      uniquePendingClient,
      '1200',
      'Pending services',
      '2025-12-15'
    );
    await expect(page.getByText(uniquePendingClient)).toBeVisible();

    await invoicePage.createBasicInvoice(
      uniquePaidClient,
      '2000',
      'Paid services',
      '2025-12-10',
      'Paid'
    );
    await expect(page.getByText(uniquePaidClient)).toBeVisible();

    await invoicePage.createBasicInvoice(
      uniqueOverdueClient,
      '800',
      'Overdue services',
      '2025-11-01',
      'Overdue'
    );
    await expect(page.getByText(uniqueOverdueClient)).toBeVisible();

    // Test filtering by Paid status
    await invoicePage.filterByStatus('Paid');
    await expect(page.getByText('✅ paid').first()).toBeVisible();
    await expect(page.getByText(uniquePaidClient)).toBeVisible();
    await expect(page.getByText(uniquePendingClient)).not.toBeVisible();
    await expect(page.getByText(uniqueOverdueClient)).not.toBeVisible();

    // Test filtering by Overdue status
    await invoicePage.filterByStatus('Overdue');
    await expect(page.getByText('⚠️ overdue').first()).toBeVisible();
    await expect(page.getByText(uniqueOverdueClient)).toBeVisible();
    await expect(page.getByText(uniquePaidClient)).not.toBeVisible();
    await expect(page.getByText(uniquePendingClient)).not.toBeVisible();

    // Test filtering by Pending status
    await invoicePage.filterByStatus('Pending');
    await page.waitForLoadState('domcontentloaded');
    await expect(page.getByText('⏳ pending').first()).toBeVisible();
    await expect(page.getByText(uniquePendingClient)).toBeVisible({ timeout: 10000 });
    await expect(page.getByText(uniquePaidClient)).not.toBeVisible();
    await expect(page.getByText(uniqueOverdueClient)).not.toBeVisible();

    // Reset filter to show all invoices
    await invoicePage.filterByStatus('All Status');
    await expect(page.getByText(uniquePendingClient)).toBeVisible();
    await expect(page.getByText(uniquePaidClient)).toBeVisible();
    await expect(page.getByText(uniqueOverdueClient)).toBeVisible();
  });
});